<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Smooth Pursuit Eye Tracking</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

#map { height: 100%; }

#gazeDot {
  position: fixed;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  pointer-events: none;
  z-index: 3000;
}

.gaze-button {
  position: absolute;
  width: 250px;
  height: 150px;
  font-size: 25px;
  background: white;
  border: 2px solid #333;
  border-radius: 8px;
  text-align: center;
  line-height: 150px;
  z-index: 2000;
}

#salzburg   { top: 40px; left: 50%; transform: translateX(-50%); }
#zoomInBtn  { top: 40px; right: 40px; }
#zoomOutBtn { bottom: 40px; right: 40px; }
#homeBtn    { bottom: 40px; left: 40px; }

#webgazerVideoContainer {
  position: fixed !important;
  top: 10px !important;
  left: 10px !important;
  width: 200px !important;
  height: 150px !important;
  z-index: 9999 !important;
  border: 2px solid red;
}
</style>
</head>

<body>

<div id="map"></div>
<div id="gazeDot"></div>

<div id="salzburg" class="gaze-button">Salzburg City</div>
<div id="zoomInBtn" class="gaze-button">Zoom In</div>
<div id="zoomOutBtn" class="gaze-button">Zoom Out</div>
<div id="homeBtn" class="gaze-button">My Location</div>

<div id="webgazerVideoContainer"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>

<script>
//map
const map = L.map("map").setView([47.8095, 13.0550], 15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

//gaze dot
const gazeDot = document.getElementById("gazeDot");
let gazeX = window.innerWidth / 2;
let gazeY = window.innerHeight / 2;
const ALPHA = 0.10;

//calibration
let minX = Infinity, maxX = -Infinity;
let minY = Infinity, maxY = -Infinity;
let calibrationFrames = 0;
const CALIBRATION_LIMIT = 150; // circa 2 Sekunden

webgazer.setGazeListener(data => {
  if (!data) return;

  //background calibration
  if (calibrationFrames < CALIBRATION_LIMIT) {
    minX = Math.min(minX, data.x);
    maxX = Math.max(maxX, data.x);
    minY = Math.min(minY, data.y);
    maxY = Math.max(maxY, data.y);
    calibrationFrames++;

    if (calibrationFrames === CALIBRATION_LIMIT) {
      minX -= 100;
      maxX += 100;
      minY -= 100;
      maxY += 100;
      console.log("Calibration fixed:", minX, maxX, minY, maxY);
    }
    return;
  }

  //normalization
  const nx = Math.min(Math.max(
    (data.x - minX) / (maxX - minX), 0), 1);

  const ny = Math.min(Math.max(
    (data.y - minY) / (maxY - minY), 0), 1);

  const tx = nx * window.innerWidth;
  const ty = ny * window.innerHeight;

  //smooth
  gazeX += ALPHA * (tx - gazeX);
  gazeY += ALPHA * (ty - gazeY);

  gazeDot.style.left = (gazeX - 5) + "px";
  gazeDot.style.top  = (gazeY - 5) + "px";
  
}).begin();

webgazer.showVideo(true);
webgazer.showPredictionPoints(false);

//buttons
const buttons = {
  zoomIn: document.getElementById("zoomInBtn"),
  zoomOut: document.getElementById("zoomOutBtn"),
  home: document.getElementById("homeBtn"),
  salzburg: document.getElementById("salzburg")
};

const counters = { zoomIn:0, zoomOut:0, home:0, salzburg:0 };
const THRESHOLD = 10;

function getZones() {
  const z = {};
  for (const k in buttons) {
    const r = buttons[k].getBoundingClientRect();
    z[k] = {
      x1: r.left - 150,
      x2: r.right + 150,
      y1: r.top - 150,
      y2: r.bottom + 150
    };
  }
  return z;
}

function checkGaze() {
  const zones = getZones();
  for (const k in zones) {
    const z = zones[k];
    if (
      gazeX >= z.x1 && gazeX <= z.x2 &&
      gazeY >= z.y1 && gazeY <= z.y2
    ) {
      counters[k]++;
      if (counters[k] >= THRESHOLD) {
        triggerAction(k);
        counters[k] = 0;
      }
    } else {
      counters[k] = 0;
    }
  }
  requestAnimationFrame(checkGaze);
}
checkGaze();

//buttons command
let userMarker = null;

function triggerAction(key) {
  console.log("ACTION:", key);

  if (key === "zoomIn") map.zoomIn();
  if (key === "zoomOut") map.zoomOut();
  if (key === "salzburg") map.setView([47.8095, 13.0550], 15);

  if (key === "home" && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 15);

      if (userMarker)
        userMarker.setLatLng([lat, lng]);
      else
        userMarker = L.circleMarker([lat, lng], {
          radius: 10,
          color: "blue",
          fillOpacity: 0.7
        }).addTo(map);
    });
  }
}
</script>

</body>
</html>
